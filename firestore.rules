rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /parties/{partyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                       && request.resource.data.name is string
                       && request.resource.data.name.size() > 2
                       && request.resource.data.date is timestamp
                       && request.resource.data.createdBy == request.auth.uid;

      // Règle de mise à jour affinée :
      allow update: if request.auth != null && (
                       // Le créateur peut mettre à jour la plupart des champs (ajoute des vérifications plus spécifiques si nécessaire)
                       (request.auth.uid == resource.data.createdBy &&
                        request.resource.data.name is string &&
                        request.resource.data.name.size() > 2 &&
                        request.resource.data.date is timestamp) ||
                       // N'importe quel utilisateur authentifié peut ajouter/mettre à jour sa propre note
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ratings']) && // Autorise uniquement les modifications du champ 'ratings'
                        request.resource.data.ratings[request.auth.uid] is number && // S'assure qu'ils définissent un nombre pour leur note
                        request.resource.data.ratings[request.auth.uid] >= 0.5 &&
                        request.resource.data.ratings[request.auth.uid] <= 5)
                     );

      allow delete: if false; // Personne ne peut supprimer via le client

      // Règles pour les sous-collections (comme les commentaires)
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.text is string
                      && request.resource.data.text.size() > 0
                      && request.resource.data.timestamp == request.time; // S'assure que le timestamp est défini par le serveur
        allow update, delete: if false; // Les commentaires sont immuables
      }
    }

    // Règles pour la collection 'users'
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }
  }
}
    