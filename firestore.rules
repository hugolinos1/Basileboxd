
rules_version = '2';

service cloud.firestore {
  // Fonction helper pour vérifier si l'utilisateur authentifié est l'administrateur
  function isAdmin() {
    return request.auth != null && request.auth.token.email == "hugues.rabier@gmail.com";
  }

  match /databases/{database}/documents {
    match /parties/{partyId} {
      // Lecture : autorisée pour tous (connectés ou non, selon votre choix précédent)
      allow read: if true;

      // Création : autorisée pour les utilisateurs connectés avec validation des données
      allow create: if request.auth != null
                   && request.resource.data.name is string
                   && request.resource.data.name.size() > 2
                   && request.resource.data.date is timestamp
                   && request.resource.data.createdBy == request.auth.uid;

      // Mise à jour : autorisée pour le créateur OU l'administrateur
      // Ceci est important car la suppression d'un média est une mise à jour (arrayRemove)
      allow update: if request.auth != null &&
                     (request.auth.uid == resource.data.createdBy || isAdmin()) &&
                     request.resource.data.name is string &&
                     request.resource.data.name.size() > 2 &&
                     request.resource.data.date is timestamp;

      // Suppression : autorisée uniquement pour l'administrateur
      allow delete: if isAdmin();

      // Sous-collection des commentaires
      match /comments/{commentId} {
        // Lecture des commentaires : autorisée pour tous
        allow read: if true;
        // Création des commentaires : autorisée pour les utilisateurs connectés
        allow create: if request.auth != null;
        // Suppression des commentaires : autorisée pour l'auteur du commentaire OU l'administrateur
        allow delete: if request.auth != null && (isAdmin() || request.auth.uid == resource.data.userId);
        // Modification des commentaires : interdite pour l'instant
        allow update: if false;
      }
    }

    match /users/{userId} {
      // Profils utilisateurs : lecture autorisée pour tous
      allow read: if true;
      // Création de profil : autorisée pour l'utilisateur lui-même
      allow create: if request.auth != null && request.auth.uid == userId;
      // Mise à jour de profil : autorisée pour l'utilisateur lui-même
      allow update: if request.auth != null && request.auth.uid == userId;
      // Suppression de profil : autorisée uniquement pour l'administrateur
      allow delete: if isAdmin();
    }
  }
}
